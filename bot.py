import os
import logging

# –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–ò –°–¢–†–û–ö–ò –ß–¢–û–ë–´ –£–ë–†–ê–¢–¨ –û–®–ò–ë–ö–£
os.environ['GRPC_VERBOSITY'] = 'ERROR'
os.environ['GLOG_minloglevel'] = '2'

from dotenv import load_dotenv
import google.generativeai as genai
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Gemini
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-1.5-flash')

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
user_conversations = {}

# –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ê–õ–û–ù–ï –ö–†–ê–°–û–¢–´
SALON_INFO = {
    "name": "Nail Studio 'Miss Gogo'",
    "address": "–≥. –ê–ª–º–∞—Ç—ã, —É–ª. –°–∞–º–∞–ª-2, 90/1",
    "phone": "+7 (747) 911-50-60",
    "working_hours": "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 10:00 –¥–æ 21:00",
    "services": {
        "–ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∂–µ–Ω—Å–∫–æ–≥–æ –º–∞–Ω–∏–∫—é—Ä–∞": [
            "–ö–æ–º–ø–ª–µ–∫—Å –º–∞–Ω–∏–∫—é—Ä–∞ - 8000 —Ç–µ–Ω–≥–µ, 9000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–Ø–ø–æ–Ω—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä - 10000 —Ç–µ–Ω–≥–µ, 11000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–ú–∞–Ω–∏–∫—é—Ä –±–µ–∑ –≥–µ–ª—å –ø–æ–∫—Ä—ã—Ç–∏—è - 5000 —Ç–µ–Ω–≥–µ",
            "–ì–µ–ª—å –ø–æ–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –º–∞–Ω–∏–∫—é—Ä–∞ - 5000 —Ç–µ–Ω–≥–µ",
            "–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –Ω–æ–≥—Ç–µ–π - 12000 —Ç–µ–Ω–≥–µ, 13000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏—è - 10000 —Ç–µ–Ω–≥–µ, 11000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–≠–∫—Å–ø—Ä–µ—Å—Å —É—Å–ª—É–≥–∞ –≤ 4 —Ä—É–∫–∏ - 2000 —Ç–µ–Ω–≥–µ"
        ],
        "–ü—Ä–æ—Ü–µ–¥—É—Ä—ã –∂–µ–Ω—Å–∫–æ–≥–æ –ø–µ–¥–∏–∫—é—Ä–∞": [
            "–ö–æ–º–ø–ª–µ–∫—Å –ø–µ–¥–∏–∫—é—Ä–∞ - 9000 —Ç–µ–Ω–≥–µ, 10000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "SMART-–ø–µ–¥–∏–∫—é—Ä - 10000 —Ç–µ–Ω–≥–µ, 11000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–ü–µ–¥–∏–∫—é—Ä –±–µ–∑ –≥–µ–ª—å –ø–æ–∫—Ä—ã—Ç–∏—è - 7000 —Ç–µ–Ω–≥–µ, 8000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–ü–µ–¥–∏–∫—é—Ä –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–æ–ø - 7500 —Ç–µ–Ω–≥–µ, 8500 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–≠–∫—Å–ø—Ä–µ—Å—Å —É—Å–ª—É–≥–∞ –≤ 4 —Ä—É–∫–∏ - 2000 —Ç–µ–Ω–≥–µ"
        ],
        "–ü—Ä–æ—Ü–µ–¥—É—Ä—ã –º—É–∂—Å–∫–æ–≥–æ –ø–µ–¥–∏–∫—é—Ä–∞": [
            "–ö–æ–º–ø–ª–µ–∫—Å –º–∞–Ω–∏–∫—é—Ä–∞ - 8500 —Ç–µ–Ω–≥–µ, 9500 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–ú–∞–Ω–∏–∫—é—Ä –±–µ–∑ –≥–µ–ª—å –ø–æ–∫—Ä—ã—Ç–∏—è - 7000 —Ç–µ–Ω–≥–µ, 8000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "–ü–µ–¥–∏–∫—é—Ä - 9500 —Ç–µ–Ω–≥–µ, 10500 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞",
            "SMART-–ø–µ–¥–∏–∫—é—Ä - 10000 —Ç–µ–Ω–≥–µ, 11000 —Ç–µ–Ω–≥–µ —É —Ç–æ–ø –º–∞—Å—Ç–µ—Ä–∞"
        ],
        "–î–∏–∑–∞–π–Ω –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏": [
            "–§—Ä–µ–Ω—á - 2000 —Ç–µ–Ω–≥–µ",
            "–°–ª–æ–∂–Ω—ã–π —Ñ—Ä–µ–Ω—á (–î–≤–æ–π–Ω–æ–π, –†–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–π) - 2500 —Ç–µ–Ω–≥–µ",
            "–û–º–±—Ä—ç/–†–∞—Å—Ç—è–∂–∫–∞/–ú—Ä–∞–º–æ—Ä - 3000 —Ç–µ–Ω–≥–µ",
            "–°–ª—é–¥–∞/–ù–∞–∫–ª–µ–π–∫–∏/–°—Ç–µ–º–ø–∏–Ω–≥ –ò –¢.–î. (1 –ù–æ–≥–æ—Ç—å) - 300 —Ç–µ–Ω–≥–µ",
            "–í—Ç–∏—Ä–∫–∞ - 2500 —Ç–µ–Ω–≥–µ",
            "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã - 3500 —Ç–µ–Ω–≥–µ",
            "–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –Ω–æ–≥—Ç–µ–π - 1000 —Ç–µ–Ω–≥–µ",
            "–†–µ–º–æ–Ω—Ç –Ω–æ–≥—Ç–µ–π - 500 —Ç–µ–Ω–≥–µ",
            "–°–Ω—è—Ç–∏–µ —á—É–∂–æ–≥–æ –≥–µ–ª—å –ø–æ–∫—Ä—ã—Ç–∏—è - 1000 —Ç–µ–Ω–≥–µ",
            "–°–Ω—è—Ç–∏–µ –±–µ–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è - 1500 —Ç–µ–Ω–≥–µ",
            "–°–Ω—è—Ç–∏–µ –Ω–∞—Ä–∞—â–µ–Ω–Ω—ã—Ö –Ω–æ–≥—Ç–µ–π (–ë–µ–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è) - 2000 —Ç–µ–Ω–≥–µ",
            "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ - 1000 —Ç–µ–Ω–≥–µ/2000 —Ç–µ–Ω–≥–µ",
            "–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –¥–ª–∏–Ω—ã –±–æ–ª—å—à–µ 3-–∫–∏ - +1000 —Ç–µ–Ω–≥–µ" 
        ],
        "–†–µ—Å–Ω–∏—Ü—ã –∏ –ë—Ä–æ–≤–∏": [
            "–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü - 8000 —Ç–µ–Ω–≥–µ",
            "–ò–∑–≥–∏–± L –∏ M - +1000 —Ç–µ–Ω–≥–µ",
            "–≠—Ñ—Ñ–µ–∫—Ç—ã - +1000 —Ç–µ–Ω–≥–µ",
            "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏—è - 6500 —Ç–µ–Ω–≥–µ",
            "–°–Ω—è—Ç–∏–µ —á—É–∂–æ–π —Ä–∞–±–æ—Ç—ã - 1000 —Ç–µ–Ω–≥–µ",
            "–°–Ω—è—Ç–∏–µ –±–µ–∑ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏—è - 2000 —Ç–µ–Ω–≥–µ",
            "–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü - 8000 —Ç–µ–Ω–≥–µ",
            "–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–≤–µ–π - 10000 —Ç–µ–Ω–≥–µ",
            "–ö–æ–º–±–æ (–õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü + –±—Ä–æ–≤–µ–π) - 17000 —Ç–µ–Ω–≥–µ",
            "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π - 4000 —Ç–µ–Ω–≥–µ",
            "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π + –ø–æ–∫—Ä–∞—Å–∫–∞ - 5500 —Ç–µ–Ω–≥–µ"
        ],
    },
    "masters": [
        "–ê–π–≥–µ—Ä–∏–º - —Ç–æ–ø –º–∞—Å—Ç–µ—Ä –ø–æ –ø–µ–¥–∏–∫—é—Ä—É (—Å—Ç–∞–∂ –±–æ–ª–µ–µ 3-—Ö –ª–µ—Ç)",
        "–ê—Ä—É–∂–∞–Ω - —Ç–æ–ø –º–∞—Å—Ç–µ—Ä –ø–æ –º–∞–Ω–∏–∫—é—Ä—É –∏ –ø–µ–¥–∏–∫—é—Ä—É (—Å—Ç–∞–∂ 6 –ª–µ—Ç)", 
        "–ê—Ä–∞–π–ª—ã–º - —Ç–æ–ø –º–∞—Å—Ç–µ—Ä –ø–æ –º–∞–Ω–∏–∫—é—Ä—É (—Å—Ç–∞–∂ 5 –ª–µ—Ç)",
        "–ò–Ω–∫–∞—Ä - —Ç–æ–ø –º–∞—Å—Ç–µ—Ä –ø–æ –º–∞–Ω–∏–∫—é—Ä—É (—Å—Ç–∞–∂ 4 –≥–æ–¥–∞)",
        "–ê—Å–µ–ª—å - –º–∞—Å—Ç–µ—Ä –ø–æ —Ä–µ—Å–Ω–∏—Ü–∞–º –∏ –±—Ä–æ–≤—è–º (—Å—Ç–∞–∂ 2 –≥–æ–¥–∞)"
    ],
    "promotions": [
        "üéâ –ù–æ–≤—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º —Å–∫–∏–¥–∫–∞ 20% –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ!",
        "üíÖ –ú–∞–Ω–∏–∫—é—Ä + –ø–µ–¥–∏–∫—é—Ä = —Å–∫–∏–¥–∫–∞ 15%",
        "‚ú® –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ 3+ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã - —Å–∫–∏–¥–∫–∞ 10%",
        "üéÅ –ö–∞–∂–¥–æ–µ 5-–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ - –ø–æ–¥–∞—Ä–æ–∫!"
    ]
}

# –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ò–ò
SYSTEM_PROMPT = f"""
–¢—ã - –ê–π–Ω–∞–≥—É–ª—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã "{SALON_INFO['name']}". –¢–µ–±–µ 21 –≥–æ–¥, —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ nail-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏ —É–∂–µ 4 –≥–æ–¥–∞ –∏ –æ–±–æ–∂–∞–µ—à—å —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è, –Ω–æ –Ω–µ —Ö–æ–ª–æ–¥–Ω–∞—è
- –í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –∏ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É
- –ì–æ–≤–æ—Ä–∏—à—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º, –Ω–æ –≤–µ–∂–ª–∏–≤–æ
- –ó–Ω–∞–µ—à—å –≤—Å–µ —Ç—Ä–µ–Ω–¥—ã –∫—Ä–∞—Å–æ—Ç—ã

–¢–í–û–ô –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –û–±—Ä–∞—â–∞–µ—à—å—Å—è –Ω–∞ "–≤—ã" –∫ –Ω–æ–≤—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
- –ú–æ–∂–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ "—Ç—ã" –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∞–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Ñ—Ä–∞–∑—ã: "–° —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É!", "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!", "–≠—Ç–æ –±—É–¥–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –ø–æ—Ç—Ä—è—Å–∞—é—â–µ!"
- –ó–∞–¥–∞–µ—à—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- –ù–µ –ø–µ—Ä–µ–≥–∏–±–∞–µ—à—å —Å –æ–≥—Ä–æ–º–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, –æ—Ç–≤–µ—á–∞–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ, —è—Å–Ω–æ, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ

–ß–¢–û –¢–´ –£–ú–ï–ï–®–¨:
‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (—Å–æ–±–∏—Ä–∞–µ—à—å –∏–º—è, —É—Å–ª—É–≥—É, –∂–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è)
‚úÖ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É—Å–ª—É–≥–∞–º –∏ —Ü–µ–Ω–∞–º
‚úÖ –†–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –º–∞—Å—Ç–µ—Ä–∞—Ö –∏ –∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
‚úÖ –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ–± –∞–∫—Ü–∏—è—Ö –∏ —Å–∫–∏–¥–∫–∞—Ö
‚úÖ –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É –∑–∞ —Å–æ–±–æ–π
‚úÖ –ü–æ–º–æ–≥–∞—Ç—å –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ê–õ–û–ù–ï:
–ù–∞–∑–≤–∞–Ω–∏–µ: {SALON_INFO['name']}
–ê–¥—Ä–µ—Å: {SALON_INFO['address']}
–¢–µ–ª–µ—Ñ–æ–Ω: {SALON_INFO['phone']}
–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: {SALON_INFO['working_hours']}

–ù–ê–®–ò –£–°–õ–£–ì–ò –ò –¶–ï–ù–´:
{chr(10).join([f"{category}: {', '.join(services)}" for category, services in SALON_INFO['services'].items()])}

–ù–ê–®–ò –ú–ê–°–¢–ï–†–ê:
{chr(10).join(SALON_INFO['masters'])}

–ê–ö–¢–£–ê–õ–¨–ù–´–ï –ê–ö–¶–ò–ò:
{chr(10).join(SALON_INFO['promotions'])}

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è - —Å–æ–±–µ—Ä–∏: –∏–º—è, —É—Å–ª—É–≥—É, –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π –∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—Ç –∫–ª–∏–µ–Ω—Ç—É
- –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞ –∫ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –∫–ª–∏–µ–Ω—Ç–∞
- –ù–µ –∑–∞—Å—Ç–∞–≤–ª—è–π –º–Ω–æ–≥–æ —á–∏—Ç–∞—Ç—å –Ω–∞—à–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ —Å–ø—Ä–æ—Å–∏–ª–∏ –¥–æ–ø—É—Å—Ç–∏–º –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –µ—Å—Ç—å, —Ç–æ –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—Ç–µ–ª –±—ã –∫–ª–∏–µ–Ω—Ç, –Ω–µ–∂–µ–ª–∏ –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å –≤—Å–µ —á—Ç–æ –µ—Å—Ç—å
- –ú–∞–∫—Å–∏–º—É–º –¥–≤–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏

–û—Ç–≤–µ—á–∞–π –Ω–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –ø–æ–º–æ–≥–∞–π –∫–ª–∏–µ–Ω—Ç–∞–º —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –∂–µ–ª–∞–Ω–Ω—ã–º–∏ –≥–æ—Å—Ç—è–º–∏ –Ω–∞—à–µ–≥–æ —Å–∞–ª–æ–Ω–∞! üíÑ‚ú®
"""


class TelegramGeminiBot:
    def __init__(self):
        self.app = Application.builder().token(TELEGRAM_TOKEN).build()
        self.setup_handlers()

    def setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        self.app.add_handler(CommandHandler("start", self.start_command))
        self.app.add_handler(CommandHandler("services", self.services_command))
        self.app.add_handler(CommandHandler("prices", self.prices_command))
        self.app.add_handler(CommandHandler("masters", self.masters_command))
        self.app.add_handler(CommandHandler("promotions", self.promotions_command))
        self.app.add_handler(CommandHandler("contact", self.contact_command))
        self.app.add_handler(CommandHandler("clear", self.clear_command))
        self.app.add_handler(CommandHandler("help", self.help_command))
        self.app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user_id = update.effective_user.id
        user_conversations[user_id] = []

        welcome_message = f"""
‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {SALON_INFO['name']}! ‚ú®

–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–π–Ω–∞–≥—É–ª—å, —è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞—à–µ–π —Å—Ç—É–¥–∏–∏. –° —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É –≤–∞–º:

üíÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
üíÑ –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é —É—Å–ª—É–≥—É  
üíÜ‚Äç‚ôÄÔ∏è –£–∑–Ω–∞—Ç—å –æ –Ω–∞—à–∏—Ö –º–∞—Å—Ç–µ—Ä–∞—Ö
üéÅ –£–∑–Ω–∞—Ç—å –æ–± –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∞–∫—Ü–∏—è—Ö
üí¨ –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:

/services - –Ω–∞—à–∏ —É—Å–ª—É–≥–∏
/prices - –ø—Ä–∞–π—Å-–ª–∏—Å—Ç  
/masters - –Ω–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞
/promotions - –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏
/contact - –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
/help - –ø–æ–º–æ—â—å

–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üòä
        """
        await update.message.reply_text(welcome_message)

    async def services_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥–∏"""
        services_text = f"üíÑ –£–°–õ–£–ì–ò –°–ê–õ–û–ù–ê {SALON_INFO['name']} üíÑ\n\n"
        
        for category, services in SALON_INFO['services'].items():
            services_text += f"üî∏ {category}:\n"
            for service in services:
                services_text += f"   ‚Ä¢ {service}\n"
            services_text += "\n"
        
        services_text += "–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è? –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ! üòä"
        await update.message.reply_text(services_text)

    async def prices_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç"""
        await self.services_command(update, context)  # –¶–µ–Ω—ã —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ —É—Å–ª—É–≥–∏

    async def masters_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Å—Ç–µ—Ä–æ–≤"""
        masters_text = f"üë©‚Äçüíº –ù–ê–®–ò –ú–ê–°–¢–ï–†–ê üë®‚Äçüíº\n\n"
        
        for master in SALON_INFO['masters']:
            masters_text += f"‚ú® {master}\n"
        
        masters_text += "\n–í—Å–µ –Ω–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞ - –Ω–∞—Å—Ç–æ—è—â–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã! –ú–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –≤–∞—Å üòä"
        await update.message.reply_text(masters_text)

    async def promotions_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ü–∏–∏"""
        promo_text = "üéâ –ê–ö–¢–£–ê–õ–¨–ù–´–ï –ê–ö–¶–ò–ò üéâ\n\n"
        
        for promo in SALON_INFO['promotions']:
            promo_text += f"{promo}\n\n"
        
        promo_text += "–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—å –µ—â–µ –∫—Ä–∞—Å–∏–≤–µ–µ —Å–æ —Å–∫–∏–¥–∫–æ–π! üíñ"
        await update.message.reply_text(promo_text)

    async def contact_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã"""
        contact_text = f"""
üìç –ö–û–ù–¢–ê–ö–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

üè¢ {SALON_INFO['name']}
üìç –ê–¥—Ä–µ—Å: {SALON_INFO['address']}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: {SALON_INFO['phone']}
üïê –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: {SALON_INFO['working_hours']}

–ñ–¥–µ–º –≤–∞—Å –≤ –Ω–∞—à–µ–º —É—é—Ç–Ω–æ–º —Å–∞–ª–æ–Ω–µ! ‚ú®
        """
        await update.message.reply_text(contact_text)

    async def clear_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞"""
        user_id = update.effective_user.id
        user_conversations[user_id] = []
        await update.message.reply_text("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω–∞! –ù–∞—á–Ω–µ–º —Å–Ω–∞—á–∞–ª–∞ üòä")

    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å"""
        help_text = """
üÜò –ö–ê–ö –Ø –ú–û–ì–£ –ü–û–ú–û–ß–¨:

üí¨ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ:
   ‚Ä¢ "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∞–Ω–∏–∫—é—Ä"  
   ‚Ä¢ "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–µ–¥–∏–∫—é—Ä?"
   ‚Ä¢ "–ö–∞–∫–∏–µ —É –≤–∞—Å –º–∞—Å—Ç–µ—Ä–∞?"
   ‚Ä¢ "–ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏?"

üìã –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:
   /services - —É—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã
   /masters - –Ω–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞  
   /promotions - –∞–∫—Ü–∏–∏
   /contact - –∫–∞–∫ –Ω–∞—Å –Ω–∞–π—Ç–∏
   /clear - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é

–Ø –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å! üíñ
        """
        await update.message.reply_text(help_text)

    async def get_gemini_response(self, user_message: str, user_id: int) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if user_id not in user_conversations:
                user_conversations[user_id] = []

            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
            user_conversations[user_id].append(f"–ö–ª–∏–µ–Ω—Ç: {user_message}")

            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
            conversation_history = user_conversations[user_id][-10:]

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            context = "\n".join(conversation_history)
            prompt = f"""
{SYSTEM_PROMPT}

–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º:
{context}

–û—Ç–≤–µ—Ç—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∫ –ê–π–Ω–∞–≥—É–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã.
            """

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            response = model.generate_content(prompt)

            if response.text:
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
                user_conversations[user_id].append(f"–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞: {response.text}")
                return response.text
            else:
                return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É! üìû"

        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini: {e}")
            return "–û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫! üòÖ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É. –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∞–º –ø–æ–º–æ–≥—É! üíñ"

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        user_message = update.message.text
        user_id = update.effective_user.id

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç
        await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Gemini
        response = await self.get_gemini_response(user_message, user_id)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await update.message.reply_text(response)

    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        print("üöÄ –ë–æ—Ç —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω!")
        self.app.run_polling()


if __name__ == '__main__':
    bot = TelegramGeminiBot()
    bot.run()
